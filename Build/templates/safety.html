<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Safety Dashboard - Your Safety Companion</title>

  <!-- Font Awesome (kept as in original) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Leaflet CSS (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    /* ========== Keep your original styling (slightly adapted where needed) ========== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    .bg-animation { position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); background-size:400% 400%; animation: gradientShift 15s ease infinite; }
    @keyframes gradientShift { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

    /* layout */
    .landing-center { display:flex; flex-direction:column; justify-content:center; align-items:center; min-height:100vh; text-align:center; padding:20px; animation:fadeIn 1s ease-in-out; }
    .app-logo { width:120px; height:120px; background:linear-gradient(135deg,#ff9a9e,#fecfef); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:30px; box-shadow:0 20px 40px rgba(0,0,0,0.1); animation:pulse 2s ease-in-out infinite; }
    .app-logo i { font-size:60px; color:#fff; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
    .landing-heading { 
  font-size:clamp(36px, 8vw, 64px); 
  font-weight:700; 
  color: white;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  margin-bottom:15px; 
  animation:slideInUp .8s ease-out; 
}
    .landing-subheading { font-size:clamp(16px,4vw,24px); color:rgba(255,255,255,0.9); margin-bottom:40px; font-weight:300; animation:slideInUp .8s ease-out .2s both; }
    .dashboard-buttons { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; max-width:800px; width:100%; animation:slideInUp .8s ease-out .4s both; }
    .dashboard-buttons button { padding:20px 30px; font-size:18px; font-weight:600; border:none; border-radius:20px; background:linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); backdrop-filter: blur(10px); color:white; cursor:pointer; transition:all .3s; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; gap:12px; box-shadow:0 8px 32px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.2); }
    .dashboard-buttons button i { font-size:24px; }
    .dashboard-buttons button::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition:left .5s; }
    .dashboard-buttons button:hover::before { left:100%; }
    .dashboard-buttons button:hover { transform:translateY(-5px) scale(1.02); box-shadow:0 15px 40px rgba(0,0,0,0.2); background:linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.2)); }

    .feature { display:none; min-height:100vh; padding:20px; animation:fadeIn .5s ease-in-out; }
    .feature.active { display:flex; flex-direction:column; }
    .feature-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:30px; padding:0 20px; }
    .back-btn { background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.3); color:white; padding:12px 20px; border-radius:50px; cursor:pointer; transition:all .3s; display:flex; align-items:center; gap:8px; font-weight:500; }

    .feature-center { display:flex; flex-direction:column; align-items:center; flex:1; padding:20px; }
    .feature-center h2 { 
  font-size:clamp(28px,6vw,48px); 
  font-weight:700; 
  color: white;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  margin-bottom:20px; 
  text-align:center; 
}
.feature-center h3 {
  color: white;
  font-weight: 400;
  margin-bottom: 30px;
  text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
}
    .card { background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15)); backdrop-filter: blur(20px); border-radius:25px; padding:40px; margin:20px; max-width:500px; width:100%; box-shadow: 0 20px 40px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.3); border:1px solid rgba(255,255,255,0.2); text-align:center; transition:all .3s ease; }
    .card:hover { transform:translateY(-10px); box-shadow: 0 30px 60px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.3); }

    input[type="text"], input[type="number"] { width:100%; padding:16px 24px; margin:10px 0; border:2px solid rgba(255,255,255,0.3); border-radius:50px; background:rgba(255,255,255,0.1); color:white; font-size:16px; backdrop-filter: blur(10px); transition:all .3s ease; }
    input[type="text"]::placeholder { color: rgba(255,255,255,0.7); }
    input[type="text"]:focus { outline:none; border-color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.15); box-shadow: 0 0 20px rgba(255,255,255,0.1); }

    .action-btn { padding:16px 32px; margin:10px; border-radius:50px; border:none; color:white; font-weight:600; font-size:16px; cursor:pointer; transition:all .3s; position:relative; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
    .action-btn.blue { background: linear-gradient(135deg, #667eea, #764ba2); }
    .action-btn.red { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }

    .map-container { position:relative; width:100%; max-width:900px; margin:20px auto; border-radius:25px; overflow:hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.2); }
    #map, #route-map { width:100%; height:400px; border-radius:23px; }

    .legend { background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15)); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.2); border-radius:20px; padding:25px; margin:20px auto; max-width:300px; box-shadow:0 15px 35px rgba(0,0,0,0.1); }
    .legend h4 { color:white; margin-bottom:15px; font-size:18px; font-weight:600; }
    .legend-item { display:flex; align-items:center; margin:12px 0; color:rgba(255,255,255,0.9); font-weight:500; }
    .dot { width:16px; height:16px; border-radius:50%; margin-right:12px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    .red { background: linear-gradient(135deg, #ff6b6b, #ee5a24); } .orange { background: linear-gradient(135deg, #ffa726, #ff7043); } .green { background: linear-gradient(135deg, #66bb6a, #43a047); }

    .status-display { background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); backdrop-filter: blur(15px); border:1px solid rgba(255,255,255,0.3); border-radius:20px; padding:20px; margin:20px auto; max-width:600px; color:white; font-size:16px; font-weight:500; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.1); }

    .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:white; animation:spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .notification { position: fixed; top:20px; right:20px; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8)); backdrop-filter: blur(20px); border-radius:15px; padding:15px 20px; color:#333; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.3); z-index:1000; transform: translateX(400px); transition: transform .3s ease; }
    .notification.show { transform: translateX(0); }

    /* responsive small tweaks */
    @media (max-width:768px) {
      .dashboard-buttons { grid-template-columns:1fr; max-width:400px; }
      .card { margin:20px 10px; padding:30px 25px; }
      #map, #route-map { height:320px; }
    }
    .emergency-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  width: 100%;
}

.emergency-btn {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 15px;
  padding: 15px 20px;
  color: white;
  text-decoration: none;
  font-weight: 500;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
}

.emergency-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
}
  </style>
</head>
<body>
  <div class="bg-animation"></div>

  <!-- Landing -->
  <div id="landing" class="feature active">
    <div class="landing-center">
      <div class="app-logo"><i class="fas fa-shield-alt"></i></div>
      <h1 class="landing-heading">Safety Dashboard</h1>
      <p class="landing-subheading">Your trusted safety companion for secure journeys</p>
      <div class="dashboard-buttons">
        <button onclick="openSection('geo')"><i class="fas fa-map-marked-alt"></i> Geo Fencing</button>
        <button onclick="openSection('safety')"><i class="fas fa-search-location"></i> Safety Score</button>
        <button onclick="openSection('route')"><i class="fas fa-route"></i> Route Monitoring</button>
        <button onclick="openSection('helpline')"><i class="fas fa-phone-alt"></i> Emergency Helpline</button>
      </div>
    </div>
  </div>

  <!-- Geo Fencing (Leaflet) -->
  <div id="geo" class="feature">
    <div class="feature-header">
      <button class="back-btn" onclick="backToHome()"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <div class="feature-center">
      <h2>Geo Fencing</h2>
      <h3>View safety zones in your area</h3>
      <div class="map-container">
        <div id="map"></div>
      </div>

      <div class="legend">
        <h4><i class="fas fa-info-circle"></i> Safety Zones</h4>
        <div class="legend-item"><span class="dot red"></span> Unsafe Zone (Score: 1-3)</div>
        <div class="legend-item"><span class="dot orange"></span> Moderate Zone (Score: 4-6)</div>
        <div class="legend-item"><span class="dot green"></span> Safe Zone (Score: 7-10)</div>
      </div>
    </div>
  </div>

  <!-- Safety Score -->
  <div id="safety" class="feature">
    <div class="feature-header">
      <button class="back-btn" onclick="backToHome()"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <div class="feature-center">
      <h2>Safety Score</h2>
      <h3>Check the safety rating of any area</h3>
      <div class="card">
        <i class="fas fa-search-location" style="font-size:48px; color:rgba(255,255,255,0.8); margin-bottom:20px;"></i>
        <input type="text" id="areaInput" placeholder="Enter area name (e.g., Connaught Place)">
        <button class="action-btn blue" onclick="getAreaScore()"><i class="fas fa-search"></i> Get Safety Score</button>
        <div id="areaScoreResult"></div>
      </div>
    </div>
  </div>

  <!-- Route Monitoring -->
  <div id="route" class="feature">
    <div class="feature-header">
      <button class="back-btn" onclick="backToHome()"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <div class="feature-center">
      <h2>Route Monitoring</h2>
      <h3>Track your journey and stay safe</h3>
      <div class="map-container">
        <div id="route-map"></div>
      </div>
      <div class="card">
        <i class="fas fa-route" style="font-size:48px; color:rgba(255,255,255,0.8); margin-bottom:20px;"></i>
        <button class="action-btn blue" onclick="startRouteMonitoring()"><i class="fas fa-play"></i> Start Monitoring</button>
        <button class="action-btn red" onclick="stopRouteMonitoring()"><i class="fas fa-stop"></i> Stop Monitoring</button>
        <div id="route-status" class="status-display"></div>
      </div>
    </div>
  </div>

  <!-- Emergency Helpline -->
  <div id="helpline" class="feature">
    <div class="feature-header">
      <button class="back-btn" onclick="backToHome()"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <div class="feature-center">
      <h2>Emergency Helpline</h2>
      <h3>Quick access to emergency services and personal contacts</h3>

      <div class="card">
        <i class="fas fa-phone-alt" style="font-size:48px; color:rgba(255,255,255,0.8); margin-bottom:20px;"></i>
        <h4 style="color:white; margin-bottom:15px; font-size:20px;">Emergency Services</h4>
       <div class="emergency-buttons">
  <a href="tel:100" class="emergency-btn"><i class="fas fa-shield-alt"></i> Police: 100</a>
  <a href="tel:101" class="emergency-btn"><i class="fas fa-fire-extinguisher"></i> Fire: 101</a>
  <a href="tel:102" class="emergency-btn"><i class="fas fa-ambulance"></i> Ambulance: 102</a>
  <a href="tel:1091" class="emergency-btn"><i class="fas fa-female"></i> Women Helpline: 1091</a>
  <a href="tel:1098" class="emergency-btn"><i class="fas fa-child"></i> Child Helpline: 1098</a>
</div>
      </div>

      <div class="card">
        <i class="fas fa-address-book" style="font-size:48px; color:rgba(255,255,255,0.8); margin-bottom:20px;"></i>
        <h4 style="color:white; margin-bottom:15px; font-size:20px;">Personal Emergency Contacts</h4>
        <input type="text" id="userContact" placeholder="Contact Name">
        <input type="text" id="userPhone" placeholder="Phone Number">
        <button class="action-btn blue" onclick="saveContact()"><i class="fas fa-plus"></i> Add Contact</button>
        <div style="margin-top:30px;">
          <h4 style="color:white; margin-bottom:15px;">Saved Contacts:</h4>
          <ul id="userContactsList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  /* =========================
     Global state & utilities
     ========================= */
  let geoMap = null;
  let routeMap = null;
  let zoneLayers = [];        // circles drawn on geoMap
  let helperMarkers = [];     // helper markers on geoMap
  let routeMarker = null;     // user marker on routeMap
  let routePolyline = null;   // polyline for route
  let routeCoords = [];
  let watchId = null;
  let currentZone = null;

  function showNotification(message, type='info') {
    const n = document.createElement('div');
    n.className = 'notification';
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(()=> n.classList.add('show'), 50);
    setTimeout(()=> {
      n.classList.remove('show');
      setTimeout(()=> document.body.removeChild(n), 350);
    }, 3000);
  }

  function openSection(sectionId) {
    document.querySelectorAll('.feature').forEach(f => f.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');

    if (sectionId === 'geo') initGeoMap();
    if (sectionId === 'route') initRouteMap();
  }

  function backToHome() {
    document.querySelectorAll('.feature').forEach(f => f.classList.remove('active'));
    document.getElementById('landing').classList.add('active');
  }

  /* =========================
     GEO MAP (Leaflet) & Zones
     ========================= */
  async function initGeoMap() {
    if (geoMap) return;
    geoMap = L.map('map').setView([28.6139, 77.2090], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(geoMap);

    // load zones and helper markers from backend
    await loadZones();
    await loadHelperMarkers();
    showNotification('Geo fencing map initialized successfully!', 'success');

    // try to show user position if available
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        L.marker([lat,lng]).addTo(geoMap).bindPopup('You are here').openPopup();
        geoMap.setView([lat,lng], 13);
      }, ()=>{}, { enableHighAccuracy:true });
    }
  }

  async function loadZones() {
    // clear any existing
    zoneLayers.forEach(l => geoMap.removeLayer(l));
    zoneLayers = [];

    try {
      const res = await fetch('/api/safety');
      const areas = await res.json();

      // areas expected: [{ name, score, lat, lng }, ...]
      areas.forEach(a => {
        const color = (a.score <= 3) ? '#ff6b6b' : (a.score <= 6 ? '#ffa726' : '#66bb6a');
        const circle = L.circle([a.lat, a.lng], {
          color: color,
          fillColor: color,
          fillOpacity: 0.25,
          radius: 1000,
          weight: 2
        }).bindPopup(`<strong>${escapeHtml(a.name)}</strong><br>Score: ${a.score}/10`);
        circle.addTo(geoMap);
        zoneLayers.push(circle);
      });
    } catch (err) {
      console.error('Error fetching zones:', err);
      showNotification('Error loading safety zones', 'error');
      // fallback to sample zones (optional)
    }
  }

  async function loadHelperMarkers() {
    // clear existing
    helperMarkers.forEach(m => geoMap.removeLayer(m));
    helperMarkers = [];

    try {
      const res = await fetch('/api/places');
      const places = await res.json(); // expected [{name,type,lat,lng},...]
      places.forEach(p => {
        const mk = L.marker([p.lat, p.lng]).addTo(geoMap).bindPopup(`<strong>${escapeHtml(p.name)}</strong><br>Type: ${escapeHtml(p.type)}`);
        helperMarkers.push(mk);
      });
    } catch (err) {
      console.error('Error loading places:', err);
    }
  }

  /* =========================
     SAFETY SCORE (Search)
     ========================= */
  async function getAreaScore() {
    const areaName = document.getElementById('areaInput').value.trim();
    const resultDiv = document.getElementById('areaScoreResult');
    if (!areaName) {
      showNotification('Please enter an area name', 'error');
      return;
    }
    resultDiv.innerHTML = '<div class="loading"></div> Checking safety score...';

    try {
      const res = await fetch('/api/safety');
      const areas = await res.json();
      const area = areas.find(a => a.name.toLowerCase() === areaName.toLowerCase());

      if (area) {
        const zone = area.score <= 3 ? "Unsafe" : (area.score <= 6 ? "Moderate" : "Safe");
        const color = area.score <= 3 ? "#ff6b6b" : (area.score <= 6 ? "#ffa726" : "#66bb6a");
        const icon = area.score <= 3 ? "exclamation-triangle" : (area.score <= 6 ? "exclamation-circle" : "shield-alt");

        resultDiv.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:center; gap:15px; flex-wrap:wrap;">
            <div style="text-align:center;">
              <i class="fas fa-${icon}" style="color:${color}; font-size:32px; margin-bottom:10px;"></i>
              <div style="font-size:20px; font-weight:bold;">Safety Score: ${area.score}/10</div>
              <div style="font-size:18px; color:${color}; font-weight:bold;">${zone} Zone</div>
            </div>
          </div>
          <div style="margin-top:15px; padding:15px; background:rgba(255,255,255,0.1); border-radius:10px; font-size:14px;">
            ${getScoreDescription(area.score)}
          </div>
        `;

        // center map on this area and open popup if map exists
        if (geoMap) {
          geoMap.setView([area.lat, area.lng], 14);
          const temp = L.circle([area.lat, area.lng], { radius: 200, color: color, fillOpacity: 0.25 }).addTo(geoMap);
          setTimeout(()=> geoMap.removeLayer(temp), 4000);
        }
        showNotification(`Safety score found for ${area.name}`, 'success');
      } else {
        resultDiv.innerHTML = `
          <div style="color:#ff6b6b; text-align:center;">
            <i class="fas fa-exclamation-triangle" style="font-size:32px; margin-bottom:10px;"></i>
            <div>Area not found in database</div>
            <div style="font-size:14px; margin-top:10px; opacity:0.8;">Try: Connaught Place, Karol Bagh, Saket, Hauz Khas</div>
          </div>
        `;
        showNotification('Area not found in database', 'error');
      }
    } catch (err) {
      console.error('Error fetching area score:', err);
      resultDiv.innerHTML = `<div style="color:#ff6b6b;"><i class="fas fa-exclamation-triangle"></i> Error fetching safety data</div>`;
      showNotification('Error fetching safety data', 'error');
    }
  }

  function getScoreDescription(score) {
    if (score <= 3) return "⚠ High risk area. Avoid traveling alone, especially at night. Stay in well-lit, populated areas.";
    if (score <= 6) return "⚡ Moderate risk area. Exercise normal precautions. Be aware of your surroundings.";
    return "✅ Safe area. Low crime rate and good security presence. Enjoy your visit!";
  }

  /* =========================
     ROUTE MONITORING (Leaflet)
     ========================= */
  function initRouteMap() {
    if (routeMap) return;
    routeMap = L.map('route-map').setView([28.6139, 77.2090], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(routeMap);
    showNotification('Route monitoring map initialized!', 'success');
  }

  function startRouteMonitoring() {
    if (!navigator.geolocation) {
      showNotification('Geolocation not supported by this browser', 'error');
      return;
    }
    if (!routeMap) initRouteMap();

    // clear any previous
    if (routePolyline) routeMap.removeLayer(routePolyline);
    if (routeMarker) routeMap.removeLayer(routeMarker);
    routeCoords = [];
    routePolyline = L.polyline(routeCoords, { color: '#667eea', weight: 4 }).addTo(routeMap);

    watchId = navigator.geolocation.watchPosition(async (position) => {
      const lat = position.coords.latitude, lng = position.coords.longitude;
      routeCoords.push([lat,lng]);

      routePolyline.setLatLngs(routeCoords);

      if (!routeMarker) {
        routeMarker = L.circleMarker([lat,lng], { radius:8, color:'#fff', fillColor:'#667eea', fillOpacity:1, weight:2 }).addTo(routeMap).bindPopup("You are here");
      } else {
        routeMarker.setLatLng([lat,lng]);
      }
      routeMap.panTo([lat,lng]);

      // check geofence with backend
      await checkGeofence(lat, lng);

    }, (err) => {
      console.error('Geolocation error:', err);
      showNotification('Error getting location', 'error');
    }, { enableHighAccuracy:true, maximumAge:0, timeout:5000 });

    document.getElementById('route-status').innerHTML = `<div style="color:#66bb6a;"><i class="fas fa-play-circle"></i> Route monitoring active - Tracking your location</div>`;
    showNotification('Route monitoring started successfully!', 'success');
  }

  function stopRouteMonitoring() {
    if (watchId) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if (routeMarker) { routeMap.removeLayer(routeMarker); routeMarker = null; }
    if (routePolyline) { routeMap.removeLayer(routePolyline); routePolyline = null; }
    routeCoords = [];
    currentZone = null;
    document.getElementById('route-status').innerHTML = '';
    showNotification('Route monitoring stopped', 'info');
  }

  /* =========================
     GEOfence check (backend)
     ========================= */
  async function checkGeofence(lat, lng) {
    try {
      const res = await fetch('/api/geofence/check', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ lat, lng })
      });
      const data = await res.json();
      // expected: { currentArea, safeScore, zone } where zone could be 'green'/'orange'/'red' or 'safe'/'moderate'...
      const zoneNormalized = (data.zone || '').toString().toLowerCase();
      const zoneLabel = zoneNormalized === 'green' || zoneNormalized === 'safe' ? 'SAFE' :
                        zoneNormalized === 'orange' || zoneNormalized === 'moderate' ? 'MODERATE' : 'UNSAFE';

      if (zoneNormalized && zoneNormalized !== currentZone) {
        currentZone = zoneNormalized;
        showNotification(`Entered ${data.currentArea} - ${zoneLabel} zone`, zoneNormalized === 'green' || zoneNormalized === 'safe' ? 'success' : (zoneNormalized === 'orange' || zoneNormalized === 'moderate' ? 'warning' : 'error'));
      }

      const statusColor = (zoneNormalized === 'green' || zoneNormalized === 'safe') ? '#66bb6a' : (zoneNormalized === 'orange' || zoneNormalized === 'moderate') ? '#ffa726' : '#ff6b6b';
      const statusIcon = (zoneNormalized === 'green' || zoneNormalized === 'safe') ? 'shield-alt' : (zoneNormalized === 'orange' || zoneNormalized === 'moderate') ? 'exclamation-circle' : 'exclamation-triangle';

      document.getElementById('route-status').innerHTML = `
        <div style="color: ${statusColor};">
          <i class="fas fa-${statusIcon}"></i>
          <strong>Current Area:</strong> ${escapeHtml(data.currentArea || 'Unknown')}<br>
          <strong>Safety Score:</strong> ${data.safeScore || '--'}/10<br>
          <strong>Zone:</strong> ${zoneLabel}
        </div>
      `;
    } catch (err) {
      console.error('Error checking geofence:', err);
    }
  }

  /* =========================
     Contacts (same logic)
     ========================= */
  function saveContact() {
    const name = document.getElementById('userContact').value.trim();
    let phone = document.getElementById('userPhone').value.trim();
    if (!name || !phone) { showNotification('Please enter both name and phone number', 'error'); return; }
    phone = phone.replace(/\D/g,'');
    if (phone.length === 10) phone = '+91-' + phone;
    else if (phone.length > 10) phone = '+91-' + phone.slice(-10);
    else { showNotification('Please enter a valid 10-digit phone number', 'error'); return; }

    const ul = document.getElementById('userContactsList');
    const li = document.createElement('li');
    li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center';
    li.innerHTML = `<div><i class="fas fa-user" style="margin-right:10px;"></i><strong>${escapeHtml(name)}:</strong> <a href="tel:${phone}" style="color:#fff; text-decoration:none;">${phone}</a></div>
                    <button onclick="removeContact(this)" style="background:#ff6b6b; border:none; color:white; padding:5px 10px; border-radius:15px; cursor:pointer; font-size:12px;"><i class="fas fa-trash"></i></button>`;
    ul.appendChild(li);
    document.getElementById('userContact').value=''; document.getElementById('userPhone').value='';
    showNotification('Emergency contact added successfully!', 'success');
  }

  function removeContact(btn) {
    const li = btn.parentElement;
    li.remove();
    showNotification('Contact removed', 'info');
  }

  /* =========================
     Utility helpers
     ========================= */
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"'`=\/]/g, function(s) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
    });
  }

  /* =========================
     Initialization
     ========================= */
  document.addEventListener('DOMContentLoaded', () => {
    // handle Enter in areaInput
    const areaInput = document.getElementById('areaInput');
    if (areaInput) areaInput.addEventListener('keypress', (e)=> { if (e.key === 'Enter') getAreaScore(); });

    // init route map lazily when user opens section
    console.log('Safety Dashboard initialized (Leaflet + backend integration)');
  });
  </script>
</body>
</html>
